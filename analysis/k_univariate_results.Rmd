---
title: "simulation results"
author: "Julia Wrobel"
date: '`r format(Sys.time(), "%Y-%m-%d")`'
output:
  html_document: 
    code_folding: hide
    toc: true
    toc_float: true
hitheme: tomorrow
highlighter: highlight.js
---

# Overview

This file loads data objects stored from simulations and produces figures for the paper. Libraries and code are sourced below. 

```{r setup, message=FALSE, warning=FALSE}
library(tidyverse)
library(viridis)
library(spatstat.random)
library(patchwork)
library(ggbreak)

knitr::opts_chunk$set(echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 9,
  fig.height = 4,
  fig.path = '../output/'
)

theme_set(theme_bw() + theme(legend.position = "bottom"))
```

# Source code

Source file for consolidating simulations

```{r}
source(here::here("source", "utils.R"))
```


# Expectation

## Clean and process simulation data

Here we load and process simulation results. Full simulations involve 36 scenarios with 50 simulated datasets each.


```{r}
# load only results for VB and TS
files = list.files(here::here("output", "20240819"), 
									 full.names =  TRUE)

# call merge_files() defined in utils.R
df = map_dfr(files, merge_files)
```



```{r}
# make comp times dataset
# ignoring holes datasets since we don't need all those scenarios
times_df = df %>%
  select(r, iter, scenario, type_char, starts_with("lambda"),
         contains("time_")) %>%
  filter(r == .15) %>%
  pivot_longer(time_kinhom:time_kperm_hole, 
               names_to = "method", values_to = "time",
               names_prefix = "time_") %>%
  separate(method, into = c("method", "hole"), 
           sep = "_", fill = "right") %>%
  filter(is.na(hole)) %>%
  select(-hole) %>%
  group_by(method, type_char, lambda_n, lambda_nm) %>%
  summarize(time = median(time)) %>%
  ungroup() %>%
  mutate(method = factor(method, levels = c("k", "kinhom", "kperm", "kepd", "kepdThin"),
                         labels = c("k", "inhom", "perm", "epd", "epd thin")))
  



# degree of clustering
doc_df = df %>%
  select(r, iter, scenario, type_char, starts_with("lambda"), starts_with("k")) %>%
  filter(r == .15, lambda_nm %in% c(50, 500)) %>%
  pivot_longer(ktheo:kepdThin_hole, 
               names_to = "method", values_to = "value") %>%
  separate(method, into = c("method", "hole"), 
           sep = "_", fill = "right") %>%
  filter(is.na(hole)) %>%
  select(-hole) %>%
  pivot_wider(names_from = method, values_from = value) %>%
  mutate(k = khat - ktheo,
         inhom = kinhomhat - kinhomtheo,
         perm = khat - kperm,
         epd = khat - kepd,
         epdThin = khat - kepdThin) %>%
  select(r, iter, scenario, type_char, contains("lambda"), k, inhom, perm, epd, epdThin) %>%
  pivot_longer(k:epdThin, names_to = "method", values_to = "value") %>%
  mutate(method = factor(method, levels = c("k", "inhom", "perm", "epd", "epdThin"),
                         labels = c("k", "inhom", "perm", "epd", "epd thin")),
         type_char = factor(type_char, levels = c("hom", "inhom", "homClust", "inhomClust"),
                            labels = c("homogeneous",
                                       "inhomogeneous",
                                       "clustered",
                                       "inhomogeneous + clustered")))
```





## Degree of clustering


```{r}
p_doc = doc_df %>%
  filter(lambda_n == 2000) %>%
  mutate(lambda_nm = factor(lambda_nm))  %>%
  ggplot(aes(lambda_nm, value, group = interaction(lambda_nm, method), fill = method)) +
  geom_boxplot() +
  labs(x = expression(lambda[m]),
       y = "degree of clustering") +
  theme_minimal() +
  theme(legend.position = "none",
        legend.title = element_blank()) +
  facet_wrap(~type_char, scales = "free", nrow = 1)
```



## Computation time


```{r}
p_times = times_df %>%
  filter(type_char == "inhomClust") %>%
  mutate(lambda_nm = factor(lambda_nm),
         lambda_n = factor(lambda_n,
                           labels = c("lambda[n]: 500",
                                      "lambda[n]: 2000",
                                      "lambda[n]: 5000"))) %>%
  ggplot(aes(lambda_nm, log(time), color = method, 
             group = interaction(lambda_nm, method))) +
  geom_point() +
  theme_minimal() + 
  theme(legend.position = "top",
        legend.title = element_blank()) +
  geom_line(aes(group = method)) +
  labs(x = expression(lambda[m]),
       y = "median log(seconds)") +
  facet_wrap(~lambda_n, labeller = label_parsed)
  
```




```{r fig_sim_expectation, fig.width=10, fig.height=5}
p_doc / p_times
```





# Variance

```{r}
#files = list.files(here::here("output", "univariate_variance", "nperm1000"),
 #                  full.names =  TRUE, recursive = TRUE, pattern = ".RDA")

#df = map_dfr(files, merge_files, variance = TRUE)
```

```{r}
files = list.files(here::here("output", "univariate_variance", "varyAbundance"),
                   full.names =  TRUE, recursive = TRUE, pattern = ".RDA")

df = map_dfr(files, merge_files, variance = TRUE)
```



Data cleaning

```{r}
df = df %>%
  select(r, iter, type, scenario, contains("lambda"), abundance, method, time, pvalue) %>%
  mutate(method = factor(method, levels = c("kperm", "kepd", "kepdThin"),
                         labels = c("perm", "KAMP", "KAMP lite"))) 
  
```





## Power/Type I error

First look at scenarios with no true clustering. Calculating P(reject Ho|Ho True)

```{r}
df %>%
  filter(type %in% c("hom", "inhom")) %>%
  group_by(type, method, lambda_n, abundance) %>%
  summarize(type1_error = sum(pvalue<= 0.05)/n()) %>%
  ungroup() %>%
  mutate(abundance = factor(abundance)) %>%
  ggplot(aes(abundance, type1_error, group = method,
             color = method)) +
  geom_point() +
  geom_jitter(width = .1) +
  geom_hline(yintercept = 0.05, linetype = 2) +
  facet_grid(type~ lambda_n)

```



```{r}
df %>%
  filter(type %in% c("hom", "inhom")) %>%
  group_by(type, method, lambda_n, abundance) %>%
  summarize(type1_error = sum(pvalue<= 0.05)/n()) %>%
  ungroup() %>%
  mutate(lambda_n = factor(lambda_n)) %>%
  ggplot(aes(lambda_n, type1_error, group = method,
             color = method, linetype = method)) +
  geom_point() +
  geom_line() +
  #ylim(0.045, 0.065) +
  #theme(legend.position = "none") +
  labs(y = "Type 1 error", x = "", title = "Type 1 error") +
  geom_hline(yintercept = 0.05, linetype = 2) +
  facet_wrap(type~abundance, ncol = 5)

```





Power = P(reject Ho|H1 True)

```{r}
df %>%
  filter(type %in% c("homClust", "inhomClust")) %>%
  group_by(type, method, lambda_n, lambda_m) %>%
  summarize(power = sum(pvalue<= 0.05)/n()) %>%
  ungroup() %>%
  mutate(lambda_m = factor(lambda_m)) %>%
  ggplot(aes(lambda_m, power, group = method,
             color = method)) +
  geom_point() +
  geom_jitter() +
  facet_grid(type~ lambda_n)


df %>%
    filter(type %in% c("homClust", "inhomClust", "inhomTightClust")) %>%
  group_by(type, method, lambda_n, abundance) %>%
  summarize(power = sum(pvalue<= 0.05)/n()) %>%
  ungroup() %>%
  mutate(lambda_n = factor(lambda_n)) %>%
  ggplot(aes(lambda_n, power, group = method,
             color = method, linetype = method)) +
  geom_point() +
  geom_line() +
  labs(y = "Power", x = "", title = "Power") +
  geom_hline(yintercept = 0.95, linetype = 2) +
  facet_wrap(type~abundance, ncol = 5)
```



